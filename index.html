<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sawee IC Day Activity</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#000000', // Pure Black
                            card: '#111111',
                            text: '#FFFFFF',
                            muted: '#AAAAAA'
                        },
                        neon: {
                            teal: '#00FFFF',
                            green: '#39FF14',
                            pink: '#FF00FF',
                            yellow: '#FFFF00'
                        }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans Thai"', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon-teal': '0 0 10px #00FFFF, 0 0 20px #00FFFF',
                        'neon-green': '0 0 10px #39FF14, 0 0 20px #39FF14',
                        'neon-pink': '0 0 10px #FF00FF, 0 0 20px #FF00FF',
                    }
                }
            }
        }
    </script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Noto Sans Thai Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Anime.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #000000; color: #FFFFFF; }
        .modal { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000;
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: #00FFFF;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #00FFFF; /* Neon Teal */
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
            box-shadow: 0 0 15px #00FFFF;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Neon Glow Text Class */
        .text-glow { text-shadow: 0 0 5px currentColor; }
        .text-glow-strong { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }

        /* Custom Scrollbar for Dark Theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00FFFF; }

        /* Dropdown Styling */
        .opt-group-1 { background-color: #dcfce7 !important; color: #000 !important; } /* Green-100 */
        .opt-group-2 { background-color: #fef9c3 !important; color: #000 !important; } /* Yellow-100 */

        /* Radio Buttons */
        .quiz-radio { width: 1.25em; height: 1.25em; accent-color: #00FFFF; margin-right: 0.5em; cursor: pointer; }
        .eval-radio { width: 1.5rem; height: 1.5rem; accent-color: #39FF14; cursor: pointer; }
    </style>
</head>
<body class="bg-dark-bg min-h-screen flex flex-col items-center text-dark-text overflow-x-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-neon-teal font-medium tracking-wider text-glow animate-pulse">LOADING SYSTEM...</p>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-md bg-black shadow-2xl min-h-screen flex flex-col relative pb-20">
        
        <!-- Header -->
        <div class="bg-gray-900 border-b border-neon-teal/50 p-6 text-center rounded-b-3xl shadow-neon-teal z-10 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-teal-900/20 to-black/80 pointer-events-none"></div>
            <h1 class="text-3xl font-bold tracking-wide text-neon-teal text-glow-strong relative z-10">Sawee IC Day</h1>
            <p class="text-sm text-gray-300 mt-2 relative z-10">สะสมแสตมป์ให้ครบทั้ง 6 ภารกิจ</p>
            
            <div id="user-info" class="mt-4 flex items-center justify-center space-x-3 hidden relative z-10">
                <img id="user-img" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-neon-teal shadow-neon-teal">
                <div class="text-left">
                    <span id="user-name" class="font-medium text-lg text-white block leading-tight">User</span>
                    <span class="text-xs text-neon-green">Status: Active</span>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-grow p-6 flex flex-col items-center">
            
            <!-- Stamps Grid -->
            <div class="grid grid-cols-2 gap-5 w-full max-w-sm" id="stamp-grid">
                <!-- Skeletons will be here initially -->
            </div>

            <!-- Training Material Button -->
            <a href="https://drive.google.com/drive/folders/1zEoXXmRL6MaUkc3bXPEpXRrCRahdg-XO?usp=sharing" target="_blank" class="mt-8 w-full block">
                <button class="w-full bg-gray-900 border border-neon-pink text-neon-pink font-bold py-4 px-6 rounded-xl shadow-neon-pink transition-all transform hover:scale-105 hover:bg-pink-900/30 flex items-center justify-center text-glow">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                    </svg>
                    เอกสารประกอบการอบรม
                </button>
            </a>

            <!-- Certificate Button -->
            <div id="cert-section" class="mt-4 w-full">
                <button id="cert-btn" onclick="generateCertificate()" disabled class="w-full bg-gray-800 text-gray-500 font-bold py-4 px-6 rounded-xl border border-gray-700 transition-all flex items-center justify-center relative overflow-hidden group">
                    <span class="relative z-10 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        รับเกียรติบัตร (Locked)
                    </span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-4 text-center text-xs text-gray-600">
            &copy; 2025 Sawee Hospital
        </div>
    </div>

    <!-- Universal Modal -->
    <div id="modal-template" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-all duration-300 backdrop-blur-sm">
        <div class="modal-overlay absolute w-full h-full bg-black/90" onclick="closeAllModals()"></div>
        
        <div class="modal-container bg-gray-900 border border-neon-teal w-11/12 md:max-w-md mx-auto rounded-2xl shadow-neon-teal z-50 overflow-hidden flex flex-col max-h-[90vh]">
            
            <div class="modal-header px-6 py-4 border-b border-gray-800 flex justify-between items-center bg-black/50">
                <p class="text-xl font-bold text-neon-teal text-glow" id="modal-title">Title</p>
                <div class="cursor-pointer text-gray-400 hover:text-white transition-colors" onclick="closeAllModals()">
                    <svg class="fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </div>
            </div>

            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar text-white">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->

    <!-- 1. Registration -->
    <template id="regis-form-template">
        <form id="regis-form" class="space-y-4">
            <div>
                <label class="block text-sm font-bold mb-1 text-neon-green">คำนำหน้าชื่อ</label>
                <select name="title" id="input-title" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-neon-green focus:ring-1 focus:ring-neon-green transition-colors">
                    <option value="">เลือกคำนำหน้า</option>
                    <option value="นาย">นาย</option>
                    <option value="นาง">นาง</option>
                    <option value="นางสาว">นางสาว</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-bold mb-1 text-neon-green">ชื่อ-สกุล</label>
                <input type="text" name="name" id="input-name" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-neon-green focus:ring-1 focus:ring-neon-green transition-colors" placeholder="ชื่อ นามสกุล">
            </div>
            <div>
                <label class="block text-sm font-bold mb-1 text-neon-green">อายุ</label>
                <input type="number" name="age" id="input-age" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-neon-green focus:ring-1 focus:ring-neon-green transition-colors" placeholder="ระบุอายุ">
            </div>
            <div>
                <label class="block text-sm font-bold mb-1 text-neon-green">เพศ</label>
                <select name="gender" id="input-gender" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-3 text-white focus:outline-none focus:border-neon-green focus:ring-1 focus:ring-neon-green transition-colors">
                    <option value="">เลือกเพศ</option>
                    <option value="ชาย">ชาย</option>
                    <option value="หญิง">หญิง</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-bold mb-1 text-neon-green">หน่วยงาน</label>
                <select name="dept" id="input-dept" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-3 text-white text-sm focus:outline-none focus:border-neon-green focus:ring-1 focus:ring-neon-green transition-colors">
                    <option value="">เลือกหน่วยงาน</option>
                    <!-- Generated via JS -->
                </select>
            </div>
            <div class="pt-4">
                <button type="button" onclick="submitRegistration()" class="w-full bg-neon-green text-black font-bold py-3 px-4 rounded-lg shadow-neon-green transition-transform transform hover:scale-105 hover:bg-green-400">
                    บันทึกข้อมูล
                </button>
            </div>
        </form>
    </template>

    <!-- 2 & 5. Quiz Form -->
    <template id="quiz-template">
        <div id="quiz-container" class="space-y-6">
            <div id="timer-container" class="hidden text-center mb-4">
                <span class="text-sm text-gray-400">เวลาที่ใช้:</span>
                <div id="timer" class="text-3xl font-mono font-bold text-neon-teal">00:00.00</div>
            </div>
            <form id="quiz-form" class="space-y-8"></form>
            <div class="pt-4">
                <button type="button" id="submit-quiz-btn" class="w-full bg-neon-teal text-black font-bold py-3 px-4 rounded-lg shadow-neon-teal transition-transform transform hover:scale-105">
                    ส่งคำตอบ
                </button>
            </div>
        </div>
    </template>

    <template id="posttest-intro-template">
        <div class="text-center space-y-6 py-4">
            <p class="text-lg leading-relaxed">
                หลังจากได้รับการอบรมแล้ว ข้อสอบต่อไปนี้คงง่ายๆ สำหรับ <span id="intro-name" class="font-bold text-neon-teal"></span> แล้วใช่มั๊ยล่ะ
            </p>
            <p class="text-sm text-gray-400">
                ข้อสอบหลังเรียนเราจะมีการจับเวลาด้วย ใครเก่ง ใครเร็ว เตรียมรับรางวัลได้เลย
            </p>
            <button type="button" onclick="startPosttestQuiz()" class="mt-4 w-full bg-neon-teal text-black font-bold py-4 px-6 rounded-xl shadow-neon-teal text-xl animate-pulse transition-transform transform hover:scale-105">
                เริ่มทำข้อสอบ
            </button>
        </div>
    </template>

    <template id="quiz-result-template">
        <div id="result-container" class="text-center space-y-8 py-4">
            <h2 class="text-2xl font-bold text-neon-teal">ผลการทดสอบ</h2>
            <div class="flex justify-center space-x-8">
                <div class="text-center">
                    <p class="text-sm text-gray-400 mb-1">คะแนน</p>
                    <div id="result-score" class="text-5xl font-bold text-white result-value">0</div>
                    <p class="text-sm text-gray-400">เต็ม 20</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-400 mb-1">เวลาที่ใช้</p>
                    <div id="result-time" class="text-3xl font-mono font-bold text-neon-teal mt-2 result-value">00:00.00</div>
                    <p class="text-sm text-gray-400">วินาที</p>
                </div>
            </div>
            <div id="ranking-section" class="pt-6 border-t border-gray-800 hidden">
                <button type="button" onclick="calculateRanking()" id="ranking-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                    สรุปอันดับ
                </button>
                <div id="ranking-result" class="mt-4 hidden space-y-2">
                     <p class="text-lg">คุณอยู่อันดับที่ <span id="rank-num" class="text-4xl font-bold text-neon-pink"></span></p>
                     <p class="text-sm text-gray-400">จากผู้เข้าสอบ <span id="total-participants"></span> คน</p>
                </div>
            </div>
        </div>
    </template>

    <!-- 3 & 4. QR Instruction -->
    <template id="qr-instruction-template">
        <div class="text-center space-y-6 py-4">
            <div class="w-32 h-32 bg-white mx-auto rounded-xl flex items-center justify-center p-2">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM5 21v-4H3v4h2zm-2-4V5H1v12h2zM5 5h14v2H5V5zm14 2v10h2V7h-2zm2 10h-4v4h4v-4z" />
                </svg>
            </div>
            <p class="text-lg text-neon-yellow">กรุณาสแกน QR Code ที่ฐานกิจกรรม</p>
            <p class="text-sm text-gray-400">เมื่อสแกนแล้ว ระบบจะบันทึกคะแนนให้โดยอัตโนมัติ</p>
            <button onclick="simulateScan()" class="text-xs text-gray-600 underline mt-4">*(Test Only) จำลองการสแกน*</button>
        </div>
    </template>

    <!-- 6. Eval Form -->
    <template id="eval-form-template">
        <div class="text-sm text-gray-400 mb-4">
            คำชี้แจง: โปรดระบุระดับความพึงพอใจ (5 = มากที่สุด ... 1 = น้อยที่สุด)
        </div>
        <form id="eval-form" class="space-y-6">
            <div id="eval-questions-container"></div>
            <div>
                <label class="block text-sm font-bold mb-2 text-neon-pink">ข้อเสนอแนะเพิ่มเติม</label>
                <textarea name="comment" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-neon-pink"></textarea>
            </div>
            <button type="button" onclick="submitEvaluation()" class="w-full bg-neon-pink text-white font-bold py-3 px-4 rounded-lg shadow-neon-pink transition-transform transform hover:scale-105">
                ส่งแบบประเมิน
            </button>
        </form>
    </template>

    <script>
        // --- CONFIGURATION ---
        const LIFF_ID = "2008690634-O4vlZdND";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwYmw1YrTSTE7O-jUmuBIJi-lYvxMp16TISA0r6-iWX5-8KsjCztqdSF3PAejBT-D68/exec";

        const missions = [
            { id: 1, name: "ลงทะเบียน", grey: "https://i.ibb.co/1t01R06C/3.png", color: "https://i.ibb.co/tTh0Q1vG/2.png" },
            { id: 2, name: "Pre-test", grey: "https://i.ibb.co/992gtTff/5.png", color: "https://i.ibb.co/4n7shj8X/4.png" },
            { id: 3, name: "Hand Hygiene", grey: "https://i.ibb.co/MxjnqNj6/7.png", color: "https://i.ibb.co/JRjjpxrZ/6.png" },
            { id: 4, name: "PPE", grey: "https://i.ibb.co/sp80k8YW/9.png", color: "https://i.ibb.co/3mSmgFhg/8.png" },
            { id: 5, name: "Post-test", grey: "https://i.ibb.co/FbHT2Ggz/11.png", color: "https://i.ibb.co/Xr7t3MHN/10.png" },
            { id: 6, name: "Evaluation", grey: "https://i.ibb.co/BKBJH9cX/13.png", color: "https://i.ibb.co/n8V2tWv7/12.png" }
        ];

        // Organization Lists
        const deptGroup1 = [
            "กลุ่มงานการพยาบาลผู้คลอด (LR)", "กลุ่มงานการแพทย์", "กลุ่มงานการแพทย์แผนไทยและการแพทย์ทางเลือก",
            "กลุ่มงานจิตเวชและยาเสพติด", "กลุ่มงานทันตกรรม", "กลุ่มงานเทคนิคการแพทย์", "กลุ่มงานบริการด้านปฐมภูมิและองค์รวม",
            "กลุ่มงานบริหารทั่วไป", "กลุ่มงานประกันสุขภาพและสารสนเทศทางการแพทย์", "กลุ่มงานรังสีวิทยา", "กลุ่มเวชกรรมฟื้นฟู",
            "คลินิกพิเศษ", "งานการพยาบาลผู้ป่วยนอก (OPD)", "งานการพยาบาลผู้ป่วยใน (IPD)", "งานการพยาบาลผู้ป่วยอุบัติเหตุและฉุกเฉิน (ER)",
            "งานจ่ายกลางและซักฟอก", "งานฝากครรภ์ (ANC)", "แม่บ้าน", "กลุ่มงานอื่นๆ", 
            "กลุ่มงานเภสัชกรรมและคุ้มครองผู้บริโภค"
        ];

        const deptGroup2 = [
            "รพ.สต.ท่าหิน", "รพ.สต.ด่านสวี", "รพ.สต.เขาทะลุ", "รพ.สต.เขาค่าย", "รพ.สต.ปากแพรก", 
            "รพ.สต.สวี", "รพ.สต.นาสัก", "รพ.สต.บ้านไทยพัฒนา", "รพ.สต.บ้านแก่งกระทั่ง", 
            "รพ.สต.บ้านคสองน้อย", "รพ.สต.ทุ่งระยะ", "รพ.สต.บ้านดอนทราย", "รพ.สต.วิสัยใตั",
            "รพ.สต.ครน", "รพ.สต.บ้านควนสามัคคี", "รพ.สต.บ้านน้ำฉา", "สสอ.สวี"
        ];

        const evalQuestions = [
            "1. ความเหมาะสมของหัวข้อการอบรม",
            "2. ความชัดเจนและเข้าใจง่ายของเนื้อหา",
            "3. ความรู้และความสามารถของวิทยากร",
            "4. ระยะเวลาในการจัดกิจกรรมเหมาะสม",
            "5. กิจกรรม/Workshop มีประโยชน์ต่อการปฏิบัติงาน",
            "6. สถานที่จัดกิจกรรมเหมาะสม",
            "7. อุปกรณ์โสตทัศนูปกรณ์มีความพร้อม",
            "8. การลงทะเบียนและการอำนวยความสะดวก",
            "9. อาหารว่าง/อาหารกลางวัน",
            "10. ภาพรวมความพึงพอใจต่อการจัดงาน"
        ];

        let userProfile = null;
        let userData = {}; // Store full user data for editing
        let userMissionStatus = [0, 0, 0, 0, 0, 0];
        let quizQuestions = [];
        let currentTestType = null;
        let userRound = null;
        let startTime = null;
        let timerInterval = null;
        let currentModalMission = null;

        // --- CORE FUNCTIONS ---

        async function main() {
            showLoading(true, "LOADING SYSTEM...");
            
            // 1. Initial Render (Skeleton)
            renderStamps(true); 

            try {
                // 2. Initialize LIFF
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                updateProfileUI();
                
                // Hide loader after basic init
                showLoading(false);

                // 3. Deep Link Handler (QR Code Scans)
                const urlParams = new URLSearchParams(window.location.search);
                const actionParam = urlParams.get('action');
                const missionParam = urlParams.get('mission');

                if (actionParam === 'complete' && missionParam) {
                    await markMissionComplete(parseInt(missionParam));
                    // Clear params
                    window.history.replaceState({}, document.title, window.location.pathname);
                }

                // 4. Fetch Data
                await fetchUserStatus();

            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error', title: 'Error', text: err.message, 
                    background: '#000', color: '#fff'
                });
                showLoading(false);
            }
        }

        // --- API & DATA ---

        async function callGAS(payload) {
            const response = await fetch(GAS_URL, {
                redirect: "follow",
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }

        async function fetchUserStatus() {
            try {
                const data = await callGAS({ action: 'getStatus', userId: userProfile.userId });
                if (data.status === 'success') {
                    userMissionStatus = data.data.missions;
                    userData = data.data.userInfo || {};
                    userRound = data.data.round;
                    renderStamps(false);
                    checkCertificateStatus();
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function markMissionComplete(missionId) {
            showLoading(true, "กำลังบันทึก...");
            try {
                const data = await callGAS({ action: 'completeMission', userId: userProfile.userId, missionId: missionId });
                if (data.status === 'success') {
                    userMissionStatus = data.data.missions;
                    renderStamps(false);
                    checkCertificateStatus();
                    showLoading(false);
                    Swal.fire({
                        icon: 'success', title: 'สำเร็จ!', text: `ภารกิจที่ ${missionId} เรียบร้อยแล้ว`,
                        timer: 2000, showConfirmButton: false, background: '#111', color: '#fff'
                    });
                    closeAllModals();
                }
            } catch (e) {
                showLoading(false);
                Swal.fire({icon: 'error', title: 'Error', text: 'บันทึกไม่สำเร็จ', background: '#111', color: '#fff'});
            }
        }

        // --- UI RENDERING ---

        function renderStamps(isSkeleton = false) {
            const grid = document.getElementById('stamp-grid');
            grid.innerHTML = '';

            missions.forEach((mission, index) => {
                const isCompleted = isSkeleton ? false : userMissionStatus[index] == 1;
                const imgUrl = isCompleted ? mission.color : mission.grey;
                
                const div = document.createElement('div');
                div.className = `aspect-square relative rounded-xl overflow-hidden transition-all duration-300 transform bg-gray-900 border-2`;
                
                if (isCompleted) {
                    div.classList.add('border-neon-green', 'shadow-neon-green', 'hover:scale-105');
                } else {
                    div.classList.add('border-gray-800', 'grayscale', 'opacity-80', 'hover:opacity-100', 'hover:scale-105', 'cursor-pointer');
                }

                div.onclick = () => handleMissionClick(mission.id, isCompleted);

                div.innerHTML = `
                    <img src="${imgUrl}" class="w-full h-full object-cover" alt="Mission ${mission.id}">
                    ${isCompleted ? '<div class="absolute inset-0 ring-2 ring-neon-green ring-inset rounded-xl"></div>' : ''}
                `;
                
                grid.appendChild(div);

                // Animation for real render
                if (!isSkeleton) {
                    anime({
                        targets: div, opacity: [0, 1], translateY: [20, 0],
                        delay: index * 100, easing: 'easeOutExpo'
                    });
                }
            });
        }

        function updateProfileUI() {
            document.getElementById('user-img').src = userProfile.pictureUrl;
            document.getElementById('user-name').innerText = userProfile.displayName;
            document.getElementById('user-info').classList.remove('hidden');
        }

        function checkCertificateStatus() {
            const allDone = userMissionStatus.every(s => s == 1);
            const btn = document.getElementById('cert-btn');
            
            if (allDone) {
                btn.disabled = false;
                btn.className = "w-full bg-black border border-neon-teal text-neon-teal font-bold py-4 px-6 rounded-xl shadow-neon-teal hover:bg-teal-900/30 text-glow transition-all flex items-center justify-center";
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    ดาวน์โหลดเกียรติบัตร
                `;
            }
        }

        // --- INTERACTION ---

        function handleMissionClick(id, isCompleted) {
            currentModalMission = id;
            
            if (id === 1) {
                openRegisModal();
            } else if (id === 2) {
                if (userMissionStatus[0] == 1) {
                    openQuizModal('Pretest');
                } else {
                    showLockAlert(1);
                }
            } else if (id === 3 || id === 4) {
                if(!isCompleted) openQRModal();
                else Swal.fire({ title: 'ภารกิจนี้สำเร็จแล้ว', icon: 'success', background: '#111', color: '#fff', timer: 1500, showConfirmButton: false });
            } else if (id === 5) {
                const allPreviousDone = userMissionStatus.slice(0, 4).every(s => s == 1);
                if (allPreviousDone) {
                    openQuizModal('Posttest');
                } else {
                    showLockAlert('1-4');
                }
            } else if (id === 6) {
                if(!isCompleted) openEvalModal();
                else Swal.fire({ title: 'ประเมินแล้ว', icon: 'success', background: '#111', color: '#fff', timer: 1500, showConfirmButton: false });
            }
        }

        function showLockAlert(req) {
            Swal.fire({
                icon: 'warning', title: 'Locked', text: `กรุณาทำภารกิจที่ ${req} ให้เสร็จก่อน`,
                background: '#111', color: '#fff', confirmButtonColor: '#00FFFF'
            });
        }

        // --- MODALS ---

        function openModal(title, content) {
            document.getElementById('modal-title').innerText = title;
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            body.appendChild(content);
            document.getElementById('modal-template').classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function closeAllModals() {
            document.getElementById('modal-template').classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
            stopTimer();
        }

        // 1. Regis Modal
        function openRegisModal() {
            const tpl = document.getElementById('regis-form-template').content.cloneNode(true);
            const deptSelect = tpl.querySelector('#input-dept');
            
            // Populate Depts
            deptGroup1.forEach(d => {
                let opt = document.createElement('option'); opt.value = d; opt.text = d; opt.className = 'opt-group-1';
                deptSelect.appendChild(opt);
            });
            deptGroup2.forEach(d => {
                let opt = document.createElement('option'); opt.value = d; opt.text = d; opt.className = 'opt-group-2';
                deptSelect.appendChild(opt);
            });

            // Pre-fill
            if (userData && userData.name) {
                tpl.querySelector('#input-title').value = userData.title || '';
                tpl.querySelector('#input-name').value = userData.name || '';
                tpl.querySelector('#input-age').value = userData.age || '';
                tpl.querySelector('#input-gender').value = userData.gender || '';
                tpl.querySelector('#input-dept').value = userData.dept || '';
            }
            openModal('ลงทะเบียน / แก้ไขข้อมูล', tpl);
        }

        // 3-4. QR Modal
        function openQRModal() {
            const tpl = document.getElementById('qr-instruction-template').content.cloneNode(true);
            openModal('สแกน QR Code ฐานกิจกรรม', tpl);
        }

        // 6. Eval Modal
        function openEvalModal() {
            const tpl = document.getElementById('eval-form-template').content.cloneNode(true);
            const container = tpl.getElementById('eval-questions-container');

            evalQuestions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 p-4 rounded-lg mb-4 border border-gray-700";
                div.innerHTML = `
                    <p class="text-neon-teal font-medium mb-3 text-sm">${q}</p>
                    <div class="flex justify-between items-center px-2">
                        ${[5,4,3,2,1].map(score => `
                            <label class="flex flex-col items-center cursor-pointer">
                                <input type="radio" name="q${idx+1}" value="${score}" required class="eval-radio mb-1">
                                <span class="text-xs text-gray-400">${score}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
            openModal('แบบประเมินความพึงพอใจ', tpl);
        }

        // 2 & 5. Quiz Modals
        async function openQuizModal(type) {
            currentTestType = type;
            showLoading(true, "Loading Quiz...");
            
            if (quizQuestions.length === 0) {
                const data = await callGAS({ action: 'getQuestions' });
                if (data.status === 'success') {
                    quizQuestions = data.data;
                } else {
                    showLoading(false);
                    Swal.fire('Error', 'Failed to load questions', 'error');
                    return;
                }
            }
            showLoading(false);

            const body = document.getElementById('modal-body');
            body.innerHTML = ''; // Clear prev content

            if (type === 'Posttest') {
                const intro = document.getElementById('posttest-intro-template').content.cloneNode(true);
                intro.querySelector('#intro-name').innerText = userProfile.displayName;
                openModal('Post-test', intro);
            } else {
                renderQuizForm(body, false);
                openModal(type === 'Pretest' ? 'Pre-test' : 'Post-test', body);
            }
        }

        function startPosttestQuiz() {
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            renderQuizForm(body, true);
            startTimer();
        }

        function renderQuizForm(container, showTimer) {
            const tpl = document.getElementById('quiz-template').content.cloneNode(true);
            if (showTimer) tpl.querySelector('#timer-container').classList.remove('hidden');
            
            const form = tpl.querySelector('#quiz-form');
            
            // Round selection for Pretest
            if (currentTestType === 'Pretest') {
                form.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded border border-gray-700 mb-6">
                        <label class="block mb-2 text-neon-green">รุ่นการอบรม</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center cursor-pointer"><input type="radio" name="round" value="รุ่น16ธ.ค." required class="quiz-radio"> <span class="ml-2">16 ธ.ค.</span></label>
                            <label class="flex items-center cursor-pointer"><input type="radio" name="round" value="รุ่น18ธ.ค." required class="quiz-radio"> <span class="ml-2">18 ธ.ค.</span></label>
                        </div>
                    </div>`;
            }

            // Questions
            quizQuestions.forEach((q, i) => {
                let choices = [
                    {k:'A', v:q.Choice_A}, {k:'B', v:q.Choice_B}, {k:'C', v:q.Choice_C}, {k:'D', v:q.Choice_D}
                ];
                shuffleArray(choices);

                form.innerHTML += `
                    <div class="bg-gray-800 p-5 rounded border border-gray-700">
                        <p class="text-lg text-white mb-3">${i+1}. ${q.Question}</p>
                        <div class="space-y-2">
                            ${choices.map(c => `
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-700 rounded transition-colors">
                                    <input type="radio" name="q_${q.ID}" value="${c.k}" required class="quiz-radio text-neon-teal">
                                    <span class="text-gray-300 ml-2">${c.v}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>`;
            });

            tpl.querySelector('#submit-quiz-btn').onclick = submitQuiz;
            if (container.tagName === 'DIV') { // If container is modal body
               container.appendChild(tpl);
            } else { // If we passed 'body' but logic expects to append to it
               container.appendChild(tpl);
            }
        }

        // --- SUBMISSION HANDLERS ---

        async function submitRegistration() {
            const form = document.getElementById('regis-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            
            showLoading(true, "Saving...");
            const fd = new FormData(form);
            const payload = {
                action: 'register',
                userId: userProfile.userId,
                displayName: userProfile.displayName,
                pictureProfile: userProfile.pictureUrl,
                title: fd.get('title'), name: fd.get('name'), age: fd.get('age'), gender: fd.get('gender'), dept: fd.get('dept')
            };

            const data = await callGAS(payload);
            if (data.status === 'success') {
                userData = payload;
                userMissionStatus = data.data.missions;
                renderStamps(false);
                closeAllModals();
                showLoading(false);
                Swal.fire({icon:'success', title:'บันทึกสำเร็จ', background:'#111', color:'#fff', timer:1500, showConfirmButton:false});
            }
        }

        async function submitQuiz() {
            const form = document.getElementById('quiz-form');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            
            stopTimer();
            showLoading(true, "Submitting...");
            
            const fd = new FormData(form);
            let score = 0, wrong = [];
            
            quizQuestions.forEach(q => {
                if (fd.get(`q_${q.ID}`) === q.Correct_Ref) score++;
                else wrong.push(q.ID);
            });

            let round = currentTestType === 'Pretest' ? fd.get('round') : userRound;
            let duration = currentTestType === 'Posttest' ? (performance.now() - startTime) / 1000 : 0;

            const payload = {
                action: 'submitTest',
                userId: userProfile.userId, displayName: userProfile.displayName,
                round: round, type: currentTestType,
                score: score, duration_sec: duration, wrong_answer: wrong.join(',')
            };

            const data = await callGAS(payload);
            if (data.status === 'success') {
                userMissionStatus = data.data.missions;
                renderStamps(false);
                showLoading(false);
                
                if (currentTestType === 'Pretest') {
                    userRound = round;
                    closeAllModals();
                    Swal.fire({title:`ได้ ${score}/20 คะแนน`, icon:'success', background:'#111', color:'#fff'});
                } else {
                    showTestResult(score, duration);
                }
            }
        }

        function showTestResult(score, duration) {
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            const tpl = document.getElementById('quiz-result-template').content.cloneNode(true);
            body.appendChild(tpl);

            // Animate Score
            anime({ targets: '#result-score', innerHTML: [0, score], round: 1, easing: 'easeInOutExpo' });
            
            document.getElementById('result-time').innerText = formatTime(duration);
            document.getElementById('ranking-section').classList.remove('hidden');
        }

        async function calculateRanking() {
            const btn = document.getElementById('ranking-btn');
            btn.innerText = 'กำลังคำนวณ...';
            
            const data = await callGAS({ action: 'getRanking', userId: userProfile.userId, round: userRound });
            
            if (data.status === 'success') {
                document.getElementById('ranking-result').classList.remove('hidden');
                document.getElementById('rank-num').innerText = data.data.rank;
                document.getElementById('total-participants').innerText = data.data.total;
                
                anime({ targets: '#rank-num', scale: [0.5, 1], opacity: [0, 1] });
            }
            btn.innerText = 'คำนวณใหม่';
        }

        async function submitEvaluation() {
            const form = document.getElementById('eval-form');
            const fd = new FormData(form);
            
            // Check completeness manually
            let complete = true;
            for(let i=1; i<=10; i++) if(!fd.get(`q${i}`)) complete = false;
            
            if (!complete) {
                Swal.fire({icon:'warning', title:'กรุณาประเมินให้ครบ', background:'#111', color:'#fff'});
                return;
            }

            showLoading(true, "Saving...");
            let payload = { action: 'submitEval', userId: userProfile.userId, comment: fd.get('comment') };
            for(let i=1; i<=10; i++) payload[`q${i}`] = fd.get(`q${i}`);

            const data = await callGAS(payload);
            if (data.status === 'success') {
                userMissionStatus = data.data.missions;
                renderStamps(false);
                checkCertificateStatus();
                closeAllModals();
                showLoading(false);
                Swal.fire({icon:'success', title:'ขอบคุณครับ', background:'#111', color:'#fff', timer:1500, showConfirmButton:false});
            }
        }

        async function generateCertificate() {
            showLoading(true, "Creating PDF...");
            try {
                const data = await callGAS({ action: 'generateCert', userId: userProfile.userId });
                showLoading(false);
                if (data.status === 'success') {
                    if (liff.isInClient()) {
                        await liff.sendMessages([{ type: 'text', text: `เกียรติบัตรของคุณ: ${data.url}` }]);
                    }
                    Swal.fire({
                        icon: 'success', 
                        html: `<a href="${data.url}" target="_blank" class="text-neon-teal underline text-lg">เปิดไฟล์ PDF</a>`, 
                        background: '#111', color: '#fff'
                    });
                }
            } catch (e) {
                showLoading(false);
                Swal.fire('Error', e.message, 'error');
            }
        }

        // --- HELPER FUNCTIONS (RESTORED) ---

        function startTimer() {
            startTime = performance.now();
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const elapsedTime = (performance.now() - startTime) / 1000;
                if(timerEl) timerEl.innerText = formatTime(elapsedTime);
            }, 80);
        }

        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const millis = Math.floor((seconds % 1) * 100);
            return `${pad(mins)}:${pad(secs)}.${pad(millis)}`;
        }

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showLoading(isLoading, message = 'กำลังโหลดข้อมูล...') {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                const msgEl = overlay.querySelector('p');
                if (msgEl) msgEl.innerText = message;
                overlay.style.display = isLoading ? 'flex' : 'none';
            }
        }
        
        function simulateScan() {
            markMissionComplete(currentModalMission);
        }

        // Start App
        main();

    </script>
</body>
</html>