<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sawee IC Day Activity</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#000000', card: '#111111', text: '#FFFFFF', muted: '#AAAAAA' },
                        neon: { teal: '#00FFFF', green: '#39FF14', pink: '#FF00FF', yellow: '#FFFF00' }
                    },
                    fontFamily: { sans: ['"Noto Sans Thai"', 'sans-serif'] },
                    boxShadow: {
                        'neon-teal': '0 0 10px #00FFFF, 0 0 20px #00FFFF',
                        'neon-green': '0 0 10px #39FF14, 0 0 20px #39FF14',
                        'neon-pink': '0 0 10px #FF00FF, 0 0 20px #FF00FF',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        }
    </script>
    <!-- LIFF & SweetAlert -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #000000; color: #FFFFFF; }
        .modal { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #00FFFF;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #00FFFF;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; box-shadow: 0 0 15px #00FFFF;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-glow { text-shadow: 0 0 5px currentColor; }
        .text-glow-strong { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        .quiz-radio, .eval-radio { width: 1.5rem; height: 1.5rem; accent-color: #00FFFF; cursor: pointer; }
        
        /* Bouncy Animation for Stamps */
        @keyframes gentle-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .stamp-bounce { animation: gentle-bounce 2s infinite ease-in-out; }
    </style>
</head>
<body class="bg-dark-bg min-h-screen flex flex-col items-center text-dark-text overflow-x-hidden">

    <!-- Loading -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-neon-teal font-medium tracking-wider text-glow animate-pulse">LOADING SYSTEM...</p>
    </div>

    <!-- Main App -->
    <div class="w-full max-w-md bg-black shadow-2xl min-h-screen flex flex-col relative pb-24">
        
        <!-- Header -->
        <div class="bg-gray-900 border-b border-neon-teal/50 p-4 rounded-b-3xl shadow-neon-teal z-10 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-b from-teal-900/20 to-black/80 pointer-events-none"></div>
            
            <div class="relative z-10 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                     <!-- Profile & Logo -->
                     <div class="relative">
                        <img id="user-img" src="" class="w-14 h-14 rounded-full border-2 border-neon-teal shadow-neon-teal object-cover">
                        <img src="https://i.ibb.co/MktBH2Pg/Screen-Shot-2568-12-15-at-14-23-06.png" class="w-6 h-6 absolute -bottom-1 -right-1 rounded-full border border-black">
                     </div>
                     <div>
                         <span id="user-name" class="font-bold text-lg text-white block leading-tight truncate w-32">User</span>
                         <span id="user-round" class="text-xs text-neon-green font-mono">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                     </div>
                </div>
                <div class="text-right">
                    <h1 class="text-2xl font-bold tracking-wide text-neon-teal text-glow">Sawee IC</h1>
                    <p class="text-xs text-gray-400">Activity Day</p>
                </div>
            </div>
        </div>

        <!-- Stamps Grid -->
        <div class="flex-grow p-6 flex flex-col items-center justify-center">
            <div class="grid grid-cols-2 gap-6 w-full max-w-sm" id="stamp-grid"></div>

            <!-- Download Certificate -->
            <div id="cert-section" class="mt-8 w-full">
                <button id="cert-btn" onclick="generateCertificate()" disabled class="w-full bg-gray-800 text-gray-500 font-bold py-4 px-6 rounded-xl border border-gray-700 transition-all flex items-center justify-center">
                    <span class="flex items-center">üîí ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£ (Locked)</span>
                </button>
            </div>
        </div>

        <!-- Footer Buttons -->
        <div class="fixed bottom-0 w-full max-w-md bg-black/90 backdrop-blur border-t border-gray-800 p-3 grid grid-cols-2 gap-3 z-20">
             <a href="https://drive.google.com/drive/folders/1zEoXXmRL6MaUkc3bXPEpXRrCRahdg-XO?usp=sharing" target="_blank">
                <button class="w-full bg-gray-900 border border-neon-pink text-neon-pink text-sm font-bold py-3 rounded-lg shadow-neon-pink text-glow hover:bg-pink-900/30">
                    ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
                </button>
            </a>
            <button onclick="openAgendaModal()" class="w-full bg-gray-900 border border-neon-yellow text-neon-yellow text-sm font-bold py-3 rounded-lg shadow-[0_0_10px_#FFFF00] text-glow animate-pulse hover:bg-yellow-900/30">
                ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°
            </button>
        </div>
    </div>

    <!-- MODAL TEMPLATE -->
    <div id="modal-template" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 transition-all duration-300 backdrop-blur-sm">
        <div class="modal-overlay absolute w-full h-full bg-black/95" onclick="closeAllModals()"></div>
        <div class="modal-container bg-gray-900 border border-neon-teal w-11/12 md:max-w-md mx-auto rounded-2xl shadow-neon-teal z-50 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="modal-header px-6 py-4 border-b border-gray-800 flex justify-between items-center bg-black/50">
                <p class="text-xl font-bold text-neon-teal text-glow" id="modal-title">Title</p>
                <div class="cursor-pointer text-gray-400 hover:text-white text-2xl" onclick="closeAllModals()">‚úï</div>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar text-white"></div>
        </div>
    </div>

    <!-- 1. REGISTRATION FORM -->
    <template id="regis-form-template">
        <form id="regis-form" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-bold mb-1 text-neon-green">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                <select name="title" id="input-title" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option><option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option><option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option></select></div>
                <div><label class="block text-sm font-bold mb-1 text-neon-green">‡πÄ‡∏û‡∏®</label><select name="gender" id="input-gender" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
            </div>
            <div><label class="block text-sm font-bold mb-1 text-neon-green">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" name="name" id="input-name" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-bold mb-1 text-neon-green">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" name="age" id="input-age" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white"></div>
                <div><label class="block text-sm font-bold mb-1 text-neon-green">‡∏£‡∏∏‡πà‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                <select name="round" id="input-round" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white font-bold text-neon-yellow">
                    <option value="‡∏£‡∏∏‡πà‡∏ô 16 ‡∏ò.‡∏Ñ.">‡∏£‡∏∏‡πà‡∏ô 16 ‡∏ò.‡∏Ñ.</option>
                    <option value="‡∏£‡∏∏‡πà‡∏ô 18 ‡∏ò.‡∏Ñ.">‡∏£‡∏∏‡πà‡∏ô 18 ‡∏ò.‡∏Ñ.</option>
                </select></div>
            </div>
            <div><label class="block text-sm font-bold mb-1 text-neon-green">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label><select name="dept" id="input-dept" required class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white text-sm"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option></select></div>
            <button type="button" onclick="submitRegistration()" class="w-full bg-neon-green text-black font-bold py-3 mt-4 rounded-lg shadow-neon-green hover:bg-green-400 transform hover:scale-105 transition-transform">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </form>
    </template>

    <!-- 2 & 5. QUIZ TEMPLATE -->
    <template id="quiz-template">
        <div id="quiz-container" class="space-y-6">
            <div id="timer-container" class="hidden text-center mb-4"><span class="text-sm text-gray-400">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span><div id="timer" class="text-4xl font-mono font-bold text-neon-teal text-glow">00:00.00</div></div>
            <form id="quiz-form" class="space-y-8"></form>
            <button type="button" id="submit-quiz-btn" class="w-full bg-neon-teal text-black font-bold py-3 rounded-lg shadow-neon-teal text-lg hover:bg-cyan-300">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
    </template>

    <!-- POST-TEST INTRO -->
    <template id="posttest-intro-template">
        <div class="text-center space-y-6 py-6">
            <h2 class="text-2xl font-bold text-white">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ô‡πà‡∏∞‡∏°‡∏µ‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß...</h2>
            <p class="text-xl text-neon-teal text-glow">"‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏∞‡∏Å‡∏±‡∏ô"</p>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <p class="text-lg text-gray-300">‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞!</p>
                <p class="text-sm text-gray-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</p>
            </div>
            <button type="button" onclick="startPosttestQuiz()" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 text-black font-bold py-5 rounded-xl shadow-neon-teal text-2xl animate-pulse hover:scale-105 transition-transform">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
            </button>
        </div>
    </template>

    <!-- QUIZ RESULT -->
    <template id="quiz-result-template">
        <div id="result-container" class="text-center space-y-8 py-4">
            <h2 class="text-3xl font-bold text-neon-teal text-glow-strong">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <div class="flex justify-center items-end space-x-8">
                <div><p class="text-gray-400 mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p><div class="text-6xl font-bold text-white text-glow"><span id="result-score">0</span><span class="text-2xl text-gray-500">/20</span></div></div>
                <div><p class="text-gray-400 mb-2">‡πÄ‡∏ß‡∏•‡∏≤</p><div id="result-time" class="text-3xl font-mono font-bold text-neon-teal">00:00</div></div>
            </div>
            <div id="ranking-section" class="pt-8 border-t border-gray-800 hidden">
                <button type="button" onclick="calculateRanking()" id="ranking-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg">‡∏î‡∏π‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
                <div id="ranking-result" class="mt-6 hidden space-y-4 bg-gray-800 p-4 rounded-xl border border-gray-700">
                     <p class="text-xl text-gray-300">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà</p>
                     <div id="rank-display" class="text-7xl font-bold text-neon-pink text-glow-strong">?</div>
                     <p class="text-sm text-gray-400">‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö <span id="total-participants" class="text-white font-bold">...</span> ‡∏Ñ‡∏ô (‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)</p>
                     <p class="text-xs text-neon-yellow mt-2 animate-pulse">*‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</p>
                </div>
            </div>
        </div>
    </template>

    <!-- 6. EVAL FORM -->
    <template id="eval-form-template">
        <div class="text-base text-gray-400 mb-4 text-center">5 = ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ... 1 = ‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
        <form id="eval-form" class="space-y-8 text-lg">
            <div id="eval-questions-container"></div>
            <div><label class="block text-base font-bold mb-2 text-neon-pink">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label><textarea name="comment" rows="3" class="w-full bg-gray-800 border-gray-700 rounded-lg p-3 text-white text-base"></textarea></div>
            <button type="button" onclick="submitEvaluation()" class="w-full bg-neon-pink text-white font-bold py-4 rounded-lg shadow-neon-pink text-xl hover:bg-pink-600">‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
        </form>
    </template>

    <!-- AGENDA MODAL -->
    <template id="agenda-template">
        <div class="space-y-6">
            <div class="text-center border-b border-gray-800 pb-4">
                <h3 class="text-xl font-bold text-neon-yellow">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</h3>
                <p class="text-sm text-gray-400 mt-1">‡∏£‡∏∏‡πà‡∏ô 1: 16 ‡∏ò.‡∏Ñ. 2568 | ‡∏£‡∏∏‡πà‡∏ô 2: 18 ‡∏ò.‡∏Ñ. 2568</p>
            </div>
            <div class="space-y-4 text-left">
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">08:00-08:30</div><div>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">08:30-09:30</div><div>‡∏û‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">09:30-10:30</div><div>‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ IC Basics</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">10:30-10:45</div><div>‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">10:45-12:00</div><div>‡∏ê‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Workshop (Hand/PPE)</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">12:00-13:00</div><div>‡∏û‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">13:00-15:30</div><div>‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</div></div>
                <div class="flex items-start"><div class="w-24 font-mono text-neon-teal">15:30-16:00</div><div>Post-test / ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</div></div>
            </div>
        </div>
    </template>
    
    <!-- QR SCAN TEMPLATE -->
    <template id="qr-instruction-template">
        <div class="text-center space-y-6 py-4">
            <div class="w-40 h-40 bg-white mx-auto rounded-xl flex items-center justify-center p-2"><svg xmlns="http://www.w3.org/2000/svg" class="w-full h-full text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM5 21v-4H3v4h2zm-2-4V5H1v12h2zM5 5h14v2H5V5zm14 2v10h2V7h-2zm2 10h-4v4h4v-4z"/></svg></div>
            <p class="text-xl text-neon-yellow font-bold">‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏ê‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
            <p class="text-sm text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô</p>
            <button onclick="simulateScan()" class="text-xs text-gray-600 underline">*(Test Only) ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô*</button>
        </div>
    </template>

    <script>
        const LIFF_ID = "2008690634-O4vlZdND";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwYmw1YrTSTE7O-jUmuBIJi-lYvxMp16TISA0r6-iWX5-8KsjCztqdSF3PAejBT-D68/exec";

        const missions = [
            { id: 1, name: "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô", grey: "https://i.ibb.co/1t01R06C/3.png", color: "https://i.ibb.co/tTh0Q1vG/2.png" },
            { id: 2, name: "Pre-test", grey: "https://i.ibb.co/992gtTff/5.png", color: "https://i.ibb.co/4n7shj8X/4.png" },
            { id: 3, name: "Hand Hygiene", grey: "https://i.ibb.co/MxjnqNj6/7.png", color: "https://i.ibb.co/JRjjpxrZ/6.png" },
            { id: 4, name: "PPE", grey: "https://i.ibb.co/sp80k8YW/9.png", color: "https://i.ibb.co/3mSmgFhg/8.png" },
            { id: 5, name: "Post-test", grey: "https://i.ibb.co/FbHT2Ggz/11.png", color: "https://i.ibb.co/Xr7t3MHN/10.png" },
            { id: 6, name: "Evaluation", grey: "https://i.ibb.co/BKBJH9cX/13.png", color: "https://i.ibb.co/n8V2tWv7/12.png" }
        ];

        const deptGroup1 = ["‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏Ñ‡∏•‡∏≠‡∏î (LR)", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏£‡∏ß‡∏°", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏á‡∏™‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏°‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π", "‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏û‡∏¥‡πÄ‡∏®‡∏©", "‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OPD)", "‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)", "‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (ER)", "‡∏á‡∏≤‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ã‡∏±‡∏Å‡∏ü‡∏≠‡∏Å", "‡∏á‡∏≤‡∏ô‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏£‡∏†‡πå (ANC)", "‡πÅ‡∏°‡πà‡∏ö‡πâ‡∏≤‡∏ô", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ"];
        const deptGroup2 = ["‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡πà‡∏≤‡∏´‡∏¥‡∏ô", "‡∏£‡∏û.‡∏™‡∏ï.‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏µ", "‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏ó‡∏∞‡∏•‡∏∏", "‡∏£‡∏û.‡∏™‡∏ï.‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πà‡∏≤‡∏¢", "‡∏£‡∏û.‡∏™‡∏ï.‡∏õ‡∏≤‡∏Å‡πÅ‡∏û‡∏£‡∏Å", "‡∏£‡∏û.‡∏™‡∏ï.‡∏™‡∏ß‡∏µ", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ô‡∏≤‡∏™‡∏±‡∏Å", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡∏û‡∏±‡∏í‡∏ô‡∏≤", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏Å‡πà‡∏á‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏á", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏™‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ó‡∏∏‡πà‡∏á‡∏£‡∏∞‡∏¢‡∏∞", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏≠‡∏ô‡∏ó‡∏£‡∏≤‡∏¢", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏ï‡∏±", "‡∏£‡∏û.‡∏™‡∏ï.‡∏Ñ‡∏£‡∏ô", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ", "‡∏£‡∏û.‡∏™‡∏ï.‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏â‡∏≤", "‡∏™‡∏™‡∏≠.‡∏™‡∏ß‡∏µ"];
        const evalQuestions = ["1. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°", "2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤", "3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£", "4. ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°", "5. ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/Workshop ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô", "6. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°", "7. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÇ‡∏™‡∏ï‡∏ó‡∏±‡∏®‡∏ô‡∏π‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°", "8. ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å", "9. ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏á/‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "10. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô"];

        let userProfile = null, userData = {}, userMissionStatus = [0,0,0,0,0,0], userRound = "N/A";
        let quizQuestions = [], currentTestType = null, startTime = null, timerInterval = null, currentModalMission = null;

        async function main() {
            renderStamps(true);
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                updateProfileUI();
                document.getElementById('loading-overlay').style.display = 'none';

                const p = new URLSearchParams(window.location.search);
                if (p.get('action') === 'complete' && p.get('mission')) {
                    await markMissionComplete(parseInt(p.get('mission')));
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                await fetchUserStatus();
            } catch (e) {
                console.error(e);
                Swal.fire({title:'Error', text:e.message, icon:'error', background:'#000', color:'#fff'});
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        async function callGAS(payload) {
            const res = await fetch(GAS_URL, { redirect: "follow", method: "POST", headers: { "Content-Type": "text/plain;charset=utf-8" }, body: JSON.stringify(payload) });
            return await res.json();
        }

        async function fetchUserStatus() {
            try {
                const d = await callGAS({ action: 'getStatus', userId: userProfile.userId });
                if (d.status === 'success') {
                    userMissionStatus = d.data.missions;
                    userData = d.data.userInfo || {};
                    userRound = d.data.round || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô";
                    updateProfileUI(); // Update round in header
                    renderStamps(false);
                    checkCertificateStatus();
                }
            } catch (e) { console.error(e); }
        }

        async function markMissionComplete(mid) {
            Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading(), background:'#111', color:'#fff'});
            try {
                const d = await callGAS({ action: 'completeMission', userId: userProfile.userId, missionId: mid });
                if (d.status === 'success') {
                    userMissionStatus = d.data.missions;
                    renderStamps(false);
                    checkCertificateStatus();
                    Swal.fire({icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', background: '#111', color: '#fff', timer: 1500, showConfirmButton: false});
                    closeAllModals();
                }
            } catch (e) { Swal.fire('Error', 'Save failed', 'error'); }
        }

        function renderStamps(isSkeleton) {
            const grid = document.getElementById('stamp-grid');
            grid.innerHTML = '';
            missions.forEach((m, i) => {
                const done = isSkeleton ? false : userMissionStatus[i] == 1;
                const img = done ? m.color : m.grey;
                const div = document.createElement('div');
                // Circular & Bouncy
                div.className = `aspect-square relative rounded-full overflow-hidden transition-all duration-300 transform bg-gray-900 border-2 ${done ? 'border-neon-green shadow-neon-green hover:scale-105' : 'border-gray-800 grayscale opacity-80 hover:opacity-100 cursor-pointer stamp-bounce'}`;
                
                div.onclick = () => handleMissionClick(m.id, done);
                div.innerHTML = `<img src="${img}" class="w-full h-full object-cover">`;
                grid.appendChild(div);
                
                if(!isSkeleton) anime({targets: div, opacity: [0, 1], scale: [0.5, 1], delay: i * 150, easing: 'easeOutElastic(1, .5)'});
            });
        }

        function updateProfileUI() {
            document.getElementById('user-img').src = userProfile.pictureUrl;
            document.getElementById('user-name').innerText = userProfile.displayName;
            document.getElementById('user-round').innerText = userRound;
            document.getElementById('user-info').classList.remove('hidden');
        }

        function checkCertificateStatus() {
            const allDone = userMissionStatus.every(s => s == 1);
            const btn = document.getElementById('cert-btn');
            if (allDone) {
                btn.disabled = false;
                btn.className = "w-full bg-black border border-neon-teal text-neon-teal font-bold py-4 px-6 rounded-xl shadow-neon-teal hover:bg-teal-900/30 text-glow transition-all animate-pulse";
                btn.innerHTML = `<span class="flex items-center justify-center">üèÜ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£</span>`;
            }
        }

        function handleMissionClick(id, isCompleted) {
            currentModalMission = id;
            if (id === 1) openRegisModal();
            else if (id === 2) {
                // Pre-test: Allow access even if completed (to see score if we stored it, or re-read) - But logic says only if Mission 1 done
                if(userMissionStatus[0] == 1) {
                    if(!isCompleted) openQuizModal('Pretest'); 
                    else Swal.fire({title:'‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', icon:'info', background:'#111', color:'#fff', timer:1500});
                }
                else showLockAlert(1);
            }
            else if (id === 3 || id === 4) {
                if(!isCompleted) openQRModal();
                else Swal.fire({title:'‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', icon:'success', background:'#111', color:'#fff', timer:1000, showConfirmButton:false});
            }
            else if (id === 5) {
                // Lock Logic: Only need Pre-test (Mission 2 -> Index 1) to be done
                if(userMissionStatus[1] == 1) {
                    if(!isCompleted) openQuizModal('Posttest');
                    else Swal.fire({title:'‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', icon:'success', background:'#111', color:'#fff', timer:1500});
                }
                else showLockAlert(2);
            }
            else if (id === 6) {
                if(!isCompleted) openEvalModal();
                else Swal.fire({title:'‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', icon:'success', background:'#111', color:'#fff', timer:1000});
            }
        }

        function showLockAlert(req) { Swal.fire({icon:'warning', title:'Locked', text:`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà ${req} ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô`, background:'#111', color:'#fff', confirmButtonColor:'#00FFFF'}); }

        // --- MODALS ---
        function openRegisModal() {
            const tpl = document.getElementById('regis-form-template').content.cloneNode(true);
            const s = tpl.querySelector('#input-dept');
            deptGroup1.forEach(d => s.add(new Option(d, d)));
            deptGroup2.forEach(d => s.add(new Option(d, d)));
            
            // Auto-select round based on date
            const today = new Date().getDate();
            const rSelect = tpl.querySelector('#input-round');
            if(today === 16) rSelect.value = "‡∏£‡∏∏‡πà‡∏ô 16 ‡∏ò.‡∏Ñ.";
            else if(today === 18) rSelect.value = "‡∏£‡∏∏‡πà‡∏ô 18 ‡∏ò.‡∏Ñ.";

            if (userData.name) {
                tpl.querySelector('#input-title').value = userData.title || '';
                tpl.querySelector('#input-name').value = userData.name || '';
                tpl.querySelector('#input-age').value = userData.age || '';
                tpl.querySelector('#input-gender').value = userData.gender || '';
                tpl.querySelector('#input-dept').value = userData.dept || '';
                tpl.querySelector('#input-round').value = userData.round || rSelect.value;
            }
            openModal('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', tpl);
        }

        function openQRModal() { openModal('‡∏™‡πÅ‡∏Å‡∏ô QR Code', document.getElementById('qr-instruction-template').content.cloneNode(true)); }
        function openAgendaModal() { openModal('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£', document.getElementById('agenda-template').content.cloneNode(true)); }
        function openEvalModal() {
            const tpl = document.getElementById('eval-form-template').content.cloneNode(true);
            const c = tpl.getElementById('eval-questions-container');
            evalQuestions.forEach((q, i) => {
                c.innerHTML += `<div class="bg-gray-800 p-4 rounded-lg border border-gray-700"><p class="text-neon-teal mb-3 text-lg">${q}</p><div class="flex justify-between px-2">${[5,4,3,2,1].map(s=>`<label class="flex flex-col items-center"><input type="radio" name="q${i+1}" value="${s}" required class="eval-radio mb-2"><span class="text-sm text-gray-400">${s}</span></label>`).join('')}</div></div>`;
            });
            openModal('‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', tpl);
        }

        async function openQuizModal(type) {
            currentTestType = type;
            Swal.fire({didOpen: () => Swal.showLoading(), background: '#111'});
            if (quizQuestions.length === 0) {
                let d = await callGAS({ action: 'getQuestions' });
                if(d.status === 'success') quizQuestions = d.data;
                else { Swal.fire('Error', 'Load failed', 'error'); return; }
            }
            Swal.close();
            const modal = document.getElementById('modal-template');
            document.getElementById('modal-title').innerText = type === 'Pretest' ? 'Pre-test' : 'Post-test';
            const body = document.getElementById('modal-body');
            body.innerHTML = '';

            if (type === 'Posttest') {
                const intro = document.getElementById('posttest-intro-template').content.cloneNode(true);
                intro.querySelector('#intro-name').innerText = userProfile.displayName;
                body.appendChild(intro);
            } else {
                renderQuizForm(body, false);
            }
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
        }

        function startPosttestQuiz() {
            const body = document.getElementById('modal-body');
            body.innerHTML = '';
            renderQuizForm(body, true);
            startTime = performance.now();
            timerInterval = setInterval(() => { document.getElementById('timer').innerText = new Date(performance.now()-startTime).toISOString().substr(14, 8); }, 80);
        }

        function renderQuizForm(container, showTimer) {
            const tpl = document.getElementById('quiz-template').content.cloneNode(true);
            if(showTimer) tpl.querySelector('#timer-container').classList.remove('hidden');
            const form = tpl.querySelector('#quiz-form');
            
            // Only Pretest needs Round Selection? No, we use userRound for Posttest implicitly.
            // But if Pretest, logic is to select round.
            // NOTE: Requirement says "Pretest select round". 
            // BUT: "Round select based on date" was asked for "Posttest page" in query? 
            // Actually usually round is set at Regis. The logic now sets round at Regis. 
            // So we don't need round selector in quiz anymore, we use userData.round.

            quizQuestions.forEach((q, i) => {
                let ch = [{v:q.Choice_A,k:'A'},{v:q.Choice_B,k:'B'},{v:q.Choice_C,k:'C'},{v:q.Choice_D,k:'D'}].sort(()=>Math.random()-0.5);
                form.innerHTML += `<div class="bg-gray-800 p-5 rounded-xl border border-gray-700"><p class="text-xl text-white mb-4 leading-relaxed font-medium">${i+1}. ${q.Question}</p><div class="space-y-3">${ch.map(c => `<label class="flex items-center p-3 hover:bg-gray-700 rounded-lg border border-gray-700 hover:border-neon-teal transition-all"><input type="radio" name="q_${q.ID}" value="${c.k}" required class="quiz-radio"><span class="text-gray-200 ml-3 text-lg">${c.v}</span></label>`).join('')}</div></div>`;
            });
            tpl.querySelector('#submit-quiz-btn').onclick = submitQuiz;
            container.appendChild(tpl);
        }

        async function submitRegistration() {
            const f = document.getElementById('regis-form');
            if (!f.checkValidity()) { f.reportValidity(); return; }
            Swal.fire({didOpen:()=>Swal.showLoading(), background:'#111'});
            const fd = new FormData(f);
            const pl = {
                action:'register', userId:userProfile.userId, displayName:userProfile.displayName, pictureProfile:userProfile.pictureUrl,
                title:fd.get('title'), name:fd.get('name'), age:fd.get('age'), gender:fd.get('gender'), dept:fd.get('dept'), round:fd.get('round')
            };
            const d = await callGAS(pl);
            if(d.status==='success') {
                userData = pl; userRound = pl.round; userMissionStatus=d.data.missions;
                updateProfileUI(); renderStamps(false); closeAllModals();
                Swal.fire({icon:'success', title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', background:'#111', color:'#fff', timer:1500, showConfirmButton:false});
            }
        }

        async function submitQuiz() {
            const f = document.getElementById('quiz-form');
            if(!f.checkValidity()) { f.reportValidity(); return; }
            if(timerInterval) clearInterval(timerInterval);
            
            Swal.fire({didOpen:()=>Swal.showLoading(), background:'#111'});
            const fd = new FormData(f);
            let score=0, wrong=[];
            quizQuestions.forEach(q => { if(fd.get(`q_${q.ID}`) === q.Correct_Ref) score++; else wrong.push(q.ID); });
            
            let dur = currentTestType === 'Posttest' ? (performance.now()-startTime)/1000 : 0;
            const pl = {
                action:'submitTest', userId:userProfile.userId, displayName:userProfile.displayName, 
                round:userRound, type:currentTestType, score:score, duration_sec:dur, wrong_answer:wrong.join(',')
            };
            const d = await callGAS(pl);
            
            if(d.status==='success') {
                userMissionStatus=d.data.missions; renderStamps(false);
                if(currentTestType==='Pretest') {
                    closeAllModals(); Swal.fire({title:`‡πÑ‡∏î‡πâ ${score}/20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, icon:'success', background:'#111', color:'#fff'});
                } else {
                    showTestResult(score, dur);
                }
            }
        }

        function showTestResult(score, dur) {
            const b = document.getElementById('modal-body'); b.innerHTML='';
            const t = document.getElementById('quiz-result-template').content.cloneNode(true);
            b.appendChild(t);
            anime({targets:'#result-score', innerHTML:[0,score], round:1, easing:'spring(1, 80, 10, 0)'});
            document.getElementById('result-time').innerText = new Date(dur*1000).toISOString().substr(14, 8);
            document.getElementById('ranking-section').classList.remove('hidden');
        }

        async function calculateRanking() {
            const rDisplay = document.getElementById('rank-display');
            document.getElementById('ranking-result').classList.remove('hidden');
            document.getElementById('ranking-btn').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...";
            
            // Random shuffle effect
            let shuffle = setInterval(() => { rDisplay.innerText = Math.floor(Math.random()*100)+1; }, 50);

            try {
                const d = await callGAS({action:'getRanking', userId:userProfile.userId, round:userRound});
                clearInterval(shuffle);
                if(d.status==='success') {
                    rDisplay.innerText = d.data.rank;
                    document.getElementById('total-participants').innerText = d.data.total;
                    anime({targets: rDisplay, scale: [0.5, 1.2, 1], color: '#FF00FF'});
                }
            } catch(e) { clearInterval(shuffle); rDisplay.innerText = "-"; }
            document.getElementById('ranking-btn').innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
        }

        async function submitEvaluation() {
            const f = document.getElementById('eval-form');
            const fd = new FormData(f);
            let ok=true; for(let i=1;i<=10;i++) if(!fd.get(`q${i}`)) ok=false;
            if(!ok) { Swal.fire({icon:'warning', title:'‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠', background:'#111', color:'#fff'}); return; }
            
            Swal.fire({didOpen:()=>Swal.showLoading(), background:'#111'});
            let pl={action:'submitEval', userId:userProfile.userId, comment:fd.get('comment')};
            for(let i=1;i<=10;i++) pl[`q${i}`]=fd.get(`q${i}`);
            
            const d=await callGAS(pl);
            if(d.status==='success') {
                userMissionStatus=d.data.missions; renderStamps(false); checkCertificateStatus(); closeAllModals();
                Swal.fire({icon:'success', title:'‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö', background:'#111', color:'#fff', timer:1500, showConfirmButton:false});
            }
        }

        async function generateCertificate() {
            Swal.fire({title:'Creating PDF...', didOpen:()=>Swal.showLoading(), background:'#111', color:'#fff'});
            try {
                const d = await callGAS({action:'generateCert', userId:userProfile.userId});
                if(d.status==='success') {
                   // Try LIFF message, but always show Swal link
                   try { if(liff.isInClient()) await liff.sendMessages([{type:'text', text:`‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${d.url}`}]); } catch(e){}
                   
                   Swal.fire({
                       icon:'success', 
                       title:'‡∏≠‡∏≠‡∏Å‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ö‡∏±‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                       html: `<a href="${d.url}" target="_blank" class="block bg-neon-teal text-black font-bold py-3 px-4 rounded mt-4">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</a>`,
                       background:'#111', color:'#fff', showConfirmButton: false
                   });
                } else { throw new Error(d.message); }
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        function openModal(t, c) {
            document.getElementById('modal-title').innerText=t;
            const b=document.getElementById('modal-body'); b.innerHTML=''; b.appendChild(c);
            document.getElementById('modal-template').classList.remove('opacity-0','pointer-events-none');
        }
        function closeAllModals() { document.getElementById('modal-template').classList.add('opacity-0','pointer-events-none'); if(timerInterval) clearInterval(timerInterval); }
        function simulateScan() { markMissionComplete(currentModalMission); }

        main();
    </script>
</body>
</html>